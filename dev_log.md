# FTP
2017-02-17

先把之前写好的线程池传输文件的丢进来了。

客户端：

把输入指令拆成两部分，命令cmd和文件名filename，把命令转换成数字就能很方便的用switch了。把switch当成中心以后再加什么功能也能很方便，之后只要增加把命令换成数字的函数(command)和switch的分支就足够了。利用command的返回值来做非法命令的过滤，goto做这种非法输入和返回重新输入的时候真的很好用啊。

服务器：

因为之前写好了线程池的流程了，直接从线程入口函数下手，修改了队列的成员，把cmd和filename增加到节点里面了，本来是希望让客户端直接传命令数字减少压力，可是果然还是有点问题的，最后还是传了字符串了，之后的处理跟客户端一样，换成数字之后用switch进行下一步的功能操作。

问题&解决：

1.客户端在读标准输入的时候读入了'\n'，导致command函数返回出错，学艺不精，不记得read是不忽略'\n'的，因为最后肯定是敲回车输入的，就不判断'\0'为输入的字符串结尾而将'\n'作为判断依据；

2.服务器的recv太快，客户端还没有send就recv结束了，导致所有命令都没接收到，最后用epoll解决的，之后应该还会再扩展epoll比如子线程完成任务然后返回接着再向客户端发消息，不过等到用到的时候再细想吧；

3.epoll_wait，在所有能加错误判断的地方都加上了，可是没有任何一个返回出现错误，但是客户端的网络套接字可读时仍然没有反应，直接退出服务器。做接收命令的测试的时候把epoll部分全部注释掉，再删除注释之后自然就好了。写代码果然是一个玄学问题；

4.send_recv_n,懒得写两个函数了，客户端没有发出正确的len，或者服务器端的接收长度有误，总之肯定是传参传错了，明天要再仔细想想了，现在真的已经有点体力透支了，还是回去好好睡一觉，睡醒起来清醒一点再想。

计划：

1.把send_recv_n的问题处理掉；

2.6个功能其实有三个都实现过了，只要命令能正确传输，就封装之前写的直接拷进去，不过已经拷进去了一部分不是；

3.因为线程的文件目录是共享的，要创建空目录，这个就丢到最后一整天去想吧。

2017-02-18

![image](https://github.com/AkiraMo/FTP/blob/dev/bugimg/server%E9%97%AE%E9%A2%98%E9%83%A8%E5%88%86%E6%BA%90%E7%A0%81.png)

![image](https://github.com/AkiraMo/FTP/blob/dev/bugimg/client%E9%97%AE%E9%A2%98%E9%83%A8%E5%88%86%E6%BA%90%E7%A0%81.png)

send_recv_n出问题部分的代码截图

使用normal.h中定义的transferdata的数据结构，首先将结构体中的buf的长度赋给len，之后传输len 4个字节及len所记录的buf的长度。

之后recv_n先接收4个字节知道之后要接收的数据长度，再进行命令及文件名的接收。

预期效果是服务器端先接收cmd的长度，之后再接收cmd并存入节点，但实际运行效果却是接收长度为0，同时曾经测试，将接收cmd时的长度固定，从客户端发送固定长度的命令，但是仍然无法接收cmd

运行结果
![image](https://github.com/AkiraMo/FTP/blob/dev/bugimg/server%E7%BB%93%E6%9E%9C.png)

![image](https://github.com/AkiraMo/FTP/blob/dev/bugimg/client%E7%BB%93%E6%9E%9C.png)

今天一天毫无进展，还卡在send和recv，不过确认了不是传参的问题，昨天想茬了。然后唯一的好消息是客户端已经确定是对的了，send没有问题了，接着就是专心解决服务器端的recv。上网拷了一份epoll的模型，虽然之前有自己写过，可是自信心被打击了一整天，已经陷入人生迷茫期对自己一点信任感都没有了呢。

现在主要怀疑是不是epoll写了一半没写全或者是时间差的问题，所以recv才接收不到数据。send成功返回并不代表成功发送数据，只是成功将数据发送到了网络，今天唯一一点收获了。

幸好之后的功能大多都写过一开始就相当快了，现在只要解决了recv的问题，让服务器成功接收，大概一天半就能做完了。当然前提是能成功接收，距离出现问题已经超过24小时了还没解决，自信这种东西都扔海里去吧（╯‵□′）╯ノ┻━┻

2017-02-19

终于找到错误的地方了，第一次出现recv自己乱跑没堵塞的时候为啥没反应过来还去加epoll，脑子得进了多少水。问题的根源就是复制错文件了，send_recv_n这个函数的实现文件，复制错了，把没改正的那个复制进来了，白白耗了我一天多。

然后今天搞定了非法输入的过滤和循环输入，乱七八糟折腾了好久，还是用goto吧，这个真的无比的好用啊，为什么学校老师都说不要用这个呢，加个判断条件，反正非法了就让它直接滚回去重新输入重新接收，因为之前就把cmd单独提取出来变成数字了，只要设一个错误码，反正只要等于错误码直接回去，什么都不用废话了。

算算时间估计是赶不上了，只能一点点爬了，总会做完的。

计划：

1.解决一下为什么第二次连接服务器端，服务器会出现端错误；

2.所有线程共用文件目录，字符串拼接好像很麻烦的样子，又要各种算长度确认符号了，以前总是迷之出现毫无规律的/君，大概是又要见面了；

3.完成文件名的非法检查，又是各种搞字符串了，反正最后非法就设个错误码goto滚回去重新收；

4.完成实际功能，虽然好像工程量很大的样子，可是感觉应该能最快完成。

2017-02-20

看吧报应来了，前面拖拖拉拉的新的活又来了，居然还把新活玩得一干二净。再加上睡眠不足彻底爆发，咖啡都不管用，昏昏沉沉了一整天。

废话之后终结下今天做了什么了

1.搞定每个线程的独立文件夹了，暂时先把用户名固定之后加上验证了再改，用用户名来确认各自的文件夹，第二次登陆也不会到别的文件夹去；

2.搞定文件名的检查，犯傻忘记存返回值了，还研究半天到底为什么正确的逻辑就是没正确结果，感觉类似的问题好像以前也干过，有的傻真的能跟一辈子；

3.完成了cd、ls、pwd的功能实现，这三个测试起来比较快，不用等我这好像时刻都会坏掉的网卡传输，本机也能连接不上，真的是日常炸网卡玩，虚拟机不想改NAT啊，IP一动又是一堆地方要改好麻烦。

问题&解决：

1.今天的遇到的全部问题都是写错字，已经不想吐槽自己了，反正肯定是一整天都在犯困的错【强力甩锅，真的好困啊，靠咖啡吊着有五六天了吧，真的睡眠严重不足了。

计划：

1.第二次链连接服务器出现段错误的地方是que_get函数，还没有修改phead就为空指针了，还没细想原因，就大概看下错哪了，明天细想下吧；

2.现在各个指令的输出都在服务器端，要想想怎么样可以最快把结果发到客户端，还有切目录之后的清屏；

3.目前退出会出现问题，客户端在收到SIGINT信号时没能好好发出数据让服务器端知道它断开了，不知道断开就一直占在队列里，虽然说把sfd设成全局，注册一个信号就能解决，可是不大想设置全局变量。话是这么说，等到真正处理的时候再没别的想法就只能用全局变量了；

4.完成剩下的三个命令，其实差不多都写过，明天先从这里开始了，之后在仔细处理别的，这已经拖了好久了。

2017-02-21

感觉每天说话的自己都会被后一天的自己打脸。

1.退出完成了，跟之前说的一样，全局变量+更改信号函数，几分钟就搞定了。

2.把输出传输到客户端也搞定了，麻烦一点，把乱七八糟的都写到一行里面，响应会快，把输出放在最底下等处理完了再输出会出现延时的问题。

问题&解决

1.把ls的输出改成客户端之后总是输出上一次的结果。忘记清空缓存我的错，光记得把客户端的缓存清空了，就是不记得把服务器端的缓存清空，一直在重复发送一样的信息。

计划：

1.实现命令实现命令实现命令，打脸吧，昨天还信誓旦旦说今天一定能搞定了，之前的每一天都信誓旦旦的说这个写起来很快，虽然确实很快，但是不写的话有什么快的。

2.第二次连接服务器的段错误，这个是最大的问题了，服务器成一次性的了。

之后速度会越来越慢了，希望这周日能赶完然后merge了。

2017-02-23

果然开始没时间了，上传下载做好了但是有bug，上传会出现客户端无法退出的情况，信号不知道为什么失效了。删除做完了，功能实现总算结束了。

计划：

1.解决上传后客户端无法退出。

2.解决服务器变一次性，已经拖了好几天了。

2017-02-24

1.上传后无法退出的问题解决，果然客户端的send_file忘记把关闭网络套接字的地方给删了；

2.把所有功能又测试了一下，加了清屏的命令调用，伪装一下进入和退出的感觉；

计划：

1.文件名的合法检查，不做这个检查真的稳定性会差；

2.解决服务器的段错误，这个一点头绪都没有啊，一样的模型为什么之前运行是好好的。

2017-02-25

解决服务器了，居然忘记修改链表的尾指针了，头指针为空了，尾指针还存着之前的值，之后再来链接就会因为头尾指针不一而无法存入队列。文件名就让我先偷个懒吧，不做误操作就不用判断文件名是否合法了，不然要判断两遍了，基本已经都做好了，这个也要改名字不能放在明显的地方了。
